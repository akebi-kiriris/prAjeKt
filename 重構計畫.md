# Learnlink 重構計畫

## 當前狀態與決策
- **日期**: 2026年1月11日
- **介面狀態**: 使用 Grid 佈局後，雖然有些地方較醜，但功能正常可用
- **資料庫策略**: 先使用 SQLite 快速開發與迭代，待 Schema 穩定後再考慮遷移至 PostgreSQL

## 開發策略：切片式開發 (Vertical Slicing)
採用「切片式開發」避免重構地獄，每次專注一個功能模組，從資料表→後端→前端完整實作並測試。

**優點：**
- 風險分散，不會一次改壞整個系統
- 每個切片都能獨立測試與上線
- Debug 容易，問題範圍明確
- 持續交付，有成就感

**執行原則：**
1. 一次只重構一個功能模組
2. 完成資料表 → API → 前端的完整流程
3. 測試通過後再進入下一個切片
4. 保持其他功能正常運作

## 功能切片優先順序
### ✅ 切片 1：待辦事項 (Todo) - 已完成
- 資料表：todos ✓
- 後端 API ✓
- 前端介面 ✓

### 切片 2：時程管理 (Timeline)
- 資料表：timelines, timeline_members
- 後端 API：CRUD、成員管理、進度計算
- 前端介面：
  - 專案管理畫面（TimelinesView）：
    - 支援專案/時程以「橫條」或「區塊」視覺化顯示（如甘特圖或日曆橫條），讓每個專案的持續時間、重疊、起訖一目了然
    - 週/月視圖，專案依時間軸顯示，提升直覺性
    - 可考慮用 Tailwind CSS 自製 UI 或整合開源日曆/甘特圖元件（如 Vue Cal、FullCalendar）
    - 保留原有時程列表，並強化視覺化呈現

### 切片 3：任務管理 (Task)
---

## 頁面分頁重構計畫（補充）

- TimelinesView（專案/時程管理）：
  - 目標：讓專案持續時間、重疊、起訖一目了然，提升管理直覺性
  - 作法：導入橫條/甘特圖/日曆視覺化，並保留表單/列表編輯功能
  - 技術：Tailwind CSS + Vue，必要時整合開源日曆/甘特圖元件

（如有其他頁面重構需求，請依此格式補充）
- 資料表：tasks, task_files, task_comments (舊SQL有)
- 後端 API：任務 CRUD、檔案上傳、留言功能
- 前端介面：任務看板、檔案管理

### 切片 4：群組訊息 (Group & Message)
- 資料表：groups, group_members, messages, message_reads
- 後端 API：群組管理、訊息發送、已讀狀態
- 前端介面：聊天室、群組列表

### 切片 5：使用者系統優化 (User)
- 資料表：users, user_profiles (擴充)
- 後端 API：個人資料、頭像上傳
- 前端介面：個人中心、設定頁面

### 未來階段：資料庫遷移
- 選項 1: PostgreSQL（適合複雜查詢與關聯）
- 選項 2: Firebase（適合即時同步，但需學習 NoSQL）

---

## 切片式開發執行範本

### 每個切片的標準流程

#### Step 1：資料表設計
- [ ] 分析功能需求，確定需要哪些資料表
- [ ] 設計欄位與資料類型
- [ ] 規劃外鍵關聯與索引
- [ ] 參考資料庫設計.md

#### Step 2：資料庫遷移
- [ ] 修改或新增 Model（backend/models/）
- [ ] 執行 `flask db migrate -m "描述"`
- [ ] 執行 `flask db upgrade`
- [ ] 驗證資料表結構正確

#### Step 3：後端 API 開發
- [ ] 建立或修改 Blueprint（backend/blueprints/）
- [ ] 實作 CRUD API
- [ ] 加入驗證與錯誤處理
- [ ] 測試 API（Postman/curl）

#### Step 4：前端開發
- [ ] 建立或修改 Vue 頁面（frontend/src/views/）
- [ ] 實作 API 呼叫（services/api.js）
- [ ] 設計使用者介面
- [ ] 測試功能流程

#### Step 5：整合測試
- [ ] 前後端聯調測試
- [ ] 邊界情況測試
- [ ] 使用者體驗優化
- [ ] 確認不影響其他功能

#### Step 6：文件更新
- [ ] 更新 API 文件
- [ ] 更新資料庫設計.md
- [ ] 記錄已知問題

---

## 當前進度追蹤

### 切片 1：待辦事項 ✅ 已完成
- ✅ todos 資料表設計（新增 title, content 欄位）
- ✅ 後端 API（CRUD、toggle 完成狀態）
- ✅ 前端介面（新增、編輯、刪除、完成/未完成分類）
- ✅ Migration 完成

### 切片 2：時程管理 🔄 進行中
- [ ] 分析 timelines 資料表需求
- [ ] 檢查是否需要 timeline_members 表（類似 group_members）
- [ ] ...

---

## 詳細執行計畫（供參考）

### 資料表設計參考

詳細的資料表結構請參考 [資料庫設計.md](資料庫設計.md)

**核心系統：**
- **使用者系統**
  - users: 基本資料（id, name, email, password, phone, created_at）
  
- **群組訊息系統**
  - groups: 群組主檔
  - group_members: 群組成員（多對多）
  - messages: 訊息內容
  - message_reads: 已讀狀態

- **任務管理系統**
  - tasks: 任務主檔
  - task_files: 任務檔案（已有 TaskFile model）
  - (task_comments: 任務留言 - 舊SQL有，建議加入)
  - (task_users: 任務成員 - 舊SQL有，建議加入)
  - todos: 待辦事項
  - timelines: 時程規劃
  - (timeline_users: 時程成員 - 舊SQL有，建議加入)

### 開發工具與技術

**當前使用（保持）**
- **前端**: Vue 3 + Vite + Pinia + Vue Router
- **後端**: Flask + SQLAlchemy + Flask-Migrate
- **資料庫**: SQLite（開發階段）
- **認證**: JWT（Flask-JWT-Extended）

**未來可能引入**
- **資料庫**: PostgreSQL（生產環境）
- **快取**: Redis
- **即時通訊**: WebSocket (Flask-SocketIO)
- **檔案儲存**: 雲端物件儲存（AWS S3/Azure Blob）

---

## 附錄：原始規劃參考（已改採切片式開發）

這是原先的階段式規劃，已改為上方的切片式開發方法。保留供參考用。

---

## 技術棧確認

### 當前使用（保持）
- **前端**: Vue 3 + Vite + Pinia + Vue Router
- **後端**: Flask + SQLAlchemy + Flask-Migrate
- **資料庫**: SQLite（開發階段）
- **認證**: JWT（Flask-JWT-Extended）

### 未來可能引入
- **資料庫**: PostgreSQL（生產環境）
- **快取**: Redis
- **即時通訊**: WebSocket (Flask-SocketIO)
- **檔案儲存**: 雲端物件儲存（AWS S3/Azure Blob）

---

## 原始目標結構（保留參考）
- 混合技術棧：`登入/`、`message/`、`畢業專題網頁/` 內有 PHP 頁面，`flask_backend/app.PY` 為 Flask 雛型，還有零散的 `app.py`、`App.vue`。
- 主要功能：課程管理、群組訊息、提案/任務/todo、檔案上傳（作業）、登入註冊。
- 靜態資源：多個 uploads 資料夾、message CSS/HTML、多個 HTML 入口。


### 目前專案狀況
- 混合技術棧：`登入/`、`message/`、`畢業專題網頁/` 內有 PHP 頁面，`flask_backend/app.PY` 為 Flask 雛型，還有零散的 `app.py`、`App.vue`。
- 主要功能：課程管理、群組訊息、提案/任務/todo、檔案上傳（作業）、登入註冊。
- 靜態資源：多個 uploads 資料夾、message CSS/HTML、多個 HTML 入口。

### 目標結構
```
/ (專案根目錄)
├─ frontend/            # Vue 前端（Vite）
│  ├─ src/
│  │  ├─ main.js / main.ts
│  │  ├─ router/
│  │  ├─ stores/        # Pinia/Vuex
│  │  ├─ components/
│  │  ├─ views/
│  │  └─ services/      # API 客戶端
│  └─ index.html
├─ backend/
│  ├─ app.py            # Flask 入口
│  ├─ config.py
│  ├─ extensions.py     # db, cors, auth
│  ├─ blueprints/
│  │  ├─ auth.py
│  │  ├─ courses.py
│  │  ├─ messages.py
│  │  ├─ tasks.py
│  │  └─ files.py
│  ├─ models/           # SQLAlchemy models
│  ├─ schemas/          # Marshmallow/Pydantic
│  ├─ services/         # 商業邏輯
│  └─ uploads/
├─ shared/
│  └─ docs/             # API 文件、ERD
└─ 重構計畫.md
```

---

## 附錄：原始遷移步驟參考

### 後端（Flask）
- 使用 `flask` + `flask-cors` + `flask-jwt-extended`（或 session）+ `SQLAlchemy` + `Marshmallow`。
- 設定：`.env` 管理 DB_URI、SECRET_KEY、UPLOAD_DIR，建議用 `python-dotenv` 載入。
- 資料表：users、groups、proposals、tasks、todos、messages、group_members、uploads/homeworks。
- Blueprint：
  - `auth`：註冊/登入/登出、密碼重設。
  - `messages`：群組 CRUD、發送/讀取/標記已讀、成員管理、通知。
  - `tasks`：任務/todo CRUD、時程、作業上傳、狀態更新。
  - `files`：上傳/下載，權限控管，儲存檔案資訊。
- API 樣式：全 JSON，統一回傳格式 `{data, error}`，處理 401/403/404/409，輸入驗證用 schema。
- 安全性：JWT access/refresh token，密碼雜湊（argon2/bcrypt），登入註冊加速率限制，CORS 設定允許前端。
- 資料庫遷移：用 `Flask-Migrate`。

## 前端（Vue）
- 使用 Vite + Vue 3 + Pinia + Vue Router + Axios。
- 路由分區：登入、訊息/群組、任務/todo/時程、個人資料/設定、作業上傳。
- 狀態管理：auth（token/user）、資料快取（群組、任務）、UI 狀態（loading/toast）。
- API 客戶端：Axios 實例，設 baseURL/env，JWT 自動刷新，錯誤統一處理。
- 表單驗證：建議用 vee-validate/yup。
- 樣式：建議 UnoCSS/Tailwind 或自訂 SCSS，元件模組化。
- 國際化：可選，初期可不做。

---

## 參考：原始遷移步驟（建議順序）
1. **盤點資料表與功能**：從 PHP/db_connect 推導 ERD，整理資料表與關聯。
2. **建立後端骨架**：Flask app、擴充、CORS、JWT、資料庫遷移、健康檢查。
3. **先做驗證**：註冊/登入/登出/me，測試保護路由。
4. **訊息/群組**：將 `message/` 相關 PHP 轉成 API：創群/加退群/發訊息/標記已讀/列表。
5. **任務/todo/作業**：轉換任務/提案/todo 流程，支援上傳、狀態更新。
6. **前端 scaffold**：Vite+Vue，基本頁面、路由、auth guard、API 客戶端。
7. **逐步開發 UI**：訊息、任務、個人資料等頁面。
8. **檔案上傳**：API 實作安全上傳/下載，前端串接，驗證檔案大小/型態。
9. **測試**：後端單元/整合測試，前端元件/e2e（Cypress/Playwright），開發用資料。
10. **部署準備**：.env 範本、Dockerfile、build script，前端靜態檔案、後端 WSGI/ASGI。

## API 合約草案（舉例）
- `POST /api/auth/register` {email,password,name}
- `POST /api/auth/login` {email,password} → tokens
- `POST /api/messages` 創群；`POST /api/messages/{id}/members` 加入；`POST /api/messages/{id}/messages` 發訊息；`PATCH /api/messages/{id}/read` 標記已讀
- `GET /api/tasks` 列表；`POST /api/tasks` 新增；`PATCH /api/tasks/{id}` 狀態更新；`POST /api/tasks/{id}/upload` 上傳作業
- `GET /api/profile/me` 取得個人資料；`PATCH /api/profile/me` 更新

## 檔案與上傳
- 檔案存於 `backend/uploads/…`，記錄檔案資訊（擁有者、型態、任務 id、大小、mime）。
- 下載權限依角色控管，若未來用物件儲存可考慮預簽名網址。
- 定期清理孤兒檔案。

## 驗證與 Session
- 建議 JWT access/refresh，HTTP-only cookie，CSRF token header。
- 密碼雜湊 argon2/bcrypt，登入註冊加速率限制。
- 角色權限 decorator 保護 API。

## 開發流程
- 工具：Python 用 black/ruff，Vue 用 eslint/prettier，pre-commit hook。
- Script：make/Invoke/npm script 管理 dev/test/lint/format。
- 文件：API/ERD 放 `shared/docs`。

## 近期行動
- 確認資料庫引擎，決定沿用或重設 schema。
- 建立 Flask + JWT + SQLAlchemy + 資料庫遷移骨架，健康檢查。
- 建立 Vite+Vue3+Pinia+Router scaffold，串接 Axios。
- 對照 PHP 端點，規劃 REST API 與資料模型。
- 決定樣式系統與 token 傳遞方式（cookie/header）。
